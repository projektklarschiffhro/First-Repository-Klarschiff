<?xml version='1.0' encoding='utf-8' ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/></head><body><p class="title">Administrationshandbuch</p><p class="subtitle">Klarschiff Backend</p><p>erstellt von</p><ul><li>Stefan Audersch</li></ul><p><strong>Änderungsübersicht</strong></p><table class="tableclass"><tr class="tableHeader"><td>Version </td><td>Datum </td><td>Bearbeiter </td><td>Beschreibung </td></tr><tr><td>1.0 </td><td>10.2011 </td><td>Stefan Audersch </td><td></td></tr></table><p><strong>Inhaltsverzeichnis</strong></p><ol style="list-style: none;"><li><a href="#klarschiffBackendAufsetzen">Klarschiff Backend aufsetzen</a></li><li><a href="#einstellungen">Einstellungen</a><ol style="list-style: none;"><li><a href="#Mailversand">Mailversand</a></li><li><a href="#Datenbank">Datenbank</a></li><li><a href="#Datenbanksynchronisation">Datenbanksynchronisation</a></li><li><a href="#AutomatischJobs">Automatisch Jobs</a></li><li><a href="#Geo">Geo</a></li><li><a href="#KartendarstellungmitOpenLayers">Kartendarstellung mit OpenLayers</a></li><li><a href="#DarstellungeinesVorgangsbzw.desOrtesineinemexternenSystem">Darstellung eines Vorgangs bzw. des Ortes in einem externen System</a></li><li><a href="#AnbindungdesWFSfrdenZustndigkeitsfinder">Anbindung des WFS für den Zuständigkeitsfinder</a></li><li><a href="#Proxy">Proxy</a></li><li><a href="#LDAP">LDAP</a></li><li><a href="#Loginseite">Loginseite</a></li><li><a href="#AnzahlUntersttzerbeiIdeen">Anzahl Unterstützer bei Ideen</a></li><li><a href="#Fehlermeldungen">Fehlermeldungen</a></li><li><a href="#Version">Version</a></li></ol></li><li><a href="#WebanwendungineinemClusterlaufenlassen">Webanwendung in einem Cluster laufen lassen</a></li></ol><h2 id="klarschiffBackendAufsetzen">Klarschiff Backend aufsetzen</h2><p>Voraussetzung für das Backend ist eine PostgreSQL Datenbank mit PostGIS, eine Java Laufzeitumgebung und ein Servlet-Container. Das Aufsetzen sollte in den folgenden Schritten erfolgen:</p><p><strong>1. PostgreSQL herunterladen und installieren</strong><br/>Für die Datenhaltung wird eine PostgreSQL Datenbank benötigt. Für das Backend sollte ein PostgreSQL ab der Version 8.x verwendet werden. Diese kann hier</p><ul><li><a href="http://www.postgresql.org/download/">http://www.postgresql.org/download/</a> bzw. hier</li><li><a href="http://www.enterprisedb.com/products-services-training/pgdownload">http://www.enterprisedb.com/products-services-training/pgdownload</a></li></ul><p>heruntergeladen werden.</p><p>Bei er Installation können alle Standareinstellungen beibehalten bleiben. Beim Kodierung sollte <em>UTF-8</em> als Standard eingestellt werden.</p><p><strong>2. PostGIS installieren</strong><br/>Die Installation von PostGIS kann über bei der PostgreSQL-Installation mit installierten Application Stack Builder erfolgen. Hierzu ist dieser mit Adminrechten zu starten. Unter dem Punkt <em>Spatial Extension</em> ist dann PostGIS zu finden, welches dann ab der Version 1.5 installiert werden sollte.</p><p><strong>3. Benutzer und Datenbank anlegen</strong><br/>Mit Hilfe des pgAdmin III kann nun bei der Datenbank ggf. ein spezieller Benutzer und eine Datenbank angelegt werden. Im Standardfall sollte der Benutzer für das Backend den Rollennamen <em>klarschiff_backend</em> und das Passwort <em>klarschiff_backend</em> haben. Die neu erstellte Rolle sollte mit entsprechenden Rechten zum Erzeugen von Tabellen, Triggerfunktionen und Triggern sowie mit rechten zum Schreiben, Lesen und Löschen von Daten in Tabellen ausgestattet sein. </p><p>Für das Backend kann nun mit pgAdmin III eine neue Datenbank angelegt werden. Die Datenbak sollte im Standardfall den Namen <em>klarschiff_backend</em> haben und als Template sollte <em>template_postgis</em> gewählt werden. </p><p><strong>4. Java herunterladen und installieren</strong><br/>Als Runtime ist Java in der Version ab 1.6 notwendig. Ein JDK oder JRE kann unter <a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk-6u27-download-440405.html">http://www.oracle.com/technetwork/java/javase/downloads/jdk-6u27-download-440405.html</a> heruntergeladen werden. Dieses ist auf dem Rechner zu installieren.</p><p><strong>5. Servlet-Container (Tomcat) herunterladen und installieren</strong><br/>Das in der Entwicklungsumgebung erzeugte Backend ist eine WAR-Datei, welchers in einem Servlet-Container ausgeführt wird. Hierfür kann beispielsweise ein Tomcat verwedet werden. Ein Tomcat ab der Version 7.0 ist notwendig und kann unter <a href="http://tomcat.apache.org/download-70.cgi">http://tomcat.apache.org/download-70.cgi</a> heruntergeladen werden.</p><p>Hinweis: Wenn ein Rechner mit Windows Vista oder Windows 7 verwendet wird, sollte die Installation des Tomcats nicht im normalen Programmordner erfolgen, da in diesem das Schreiben von Dateien notwendig ist, was teilweise durch das UAC verhindert bzw. erschwert wird.</p><p>Der Tomcat sollte bei der Installation als Dienst eingerichtet werden. Um ein <em>OutOfMemory</em> zu verhindern sollte der Speicher für die VM beim Tomcat entsprechend hoch gesetzt werden.</p><p>Die Webanwendung kann ebenfalls in einem Cluster laufen. Hierzu sin dann spezielle Einstellungen notwendig.</p><p><strong>6. settings.properties ggf. anpassen</strong><br/>In der WAR-Datei der Webanwendung befindet sich im Verzeichnis <code>WEB-INF\classes\</code> die Datei <code>settings.properties</code> mit den Einstellungen für das Backend. Hier sollten ggf. Anpassungen vorgenommen werden.</p><p><strong>7. Webanwendung deployen</strong><br/>Die WAR-Datei ist beim Tomcat in das Verzeichnis <code>webapps</code> zu kopieren und damit zu deployen.</p><p><strong>8. Tomcat starten</strong><br/>Der Tomcat kann nun gestartet werden. Beim Start werden dabei die notwendigen Tabellen in der Datenbank angelegt.</p><p>Unter der URL <a href="http://localhost:8080/klarschiff.webapp/">http://localhost:8080/klarschiff.webapp/</a> sollte nun das Backend erreichbar sein.</p><h2 id="einstellungen">Einstellungen</h2><p>Die Konfigurationen und Einstellungen der Anwendung werden an verschieden Stellen vorgenommen. Zentraller Punkt für die Einstellungen ist die <code>settings.properties</code>. Hier können alle Parameter für den Lauf der Anwendung angepasst werden.</p><p>Systemspeziefischere Anpassungen, die z.B. bei der Weiterentwicklung vorgenommen werden müssen, können im ApplicationContext (<code>src_main\META-INF\spring\..xml</code>), dem WebApplicationContext (<code>WebContent\WEB-INF\spring\webmvc-config.xml</code>)oder an anderen Stellen vorgenommen werden.</p><p>Bei den Einstellungen in der <code>settings.properties</code> können Profile verwendet werden. Diese ermöglichen es verschieden Einstellungen zu definieren, die gleiche Webanwendung auf verscheidenen Rechner zu deployen und da jeweils unterschiedliche Konfigurationen zu verwenden. Welches Profil verwendet wird kann über die Variable <code>KLARSCHIFF_HRO_PROFILE</code> an den folgenden Stellen festgelegt werden:</p><ul><li>Umgebunsvariable des Rechners</li><li>Java-Laufzeit-Umgebungsvariable</li><li>in der Datei <code>settings.properties</code></li></ul><p>Die spezialisierung eines Paramters für ein bestimmtes Profil erfolgt durch ein Voranstellen der Profilnamens in der <code>settings.properties</code>. Werden die Einstellungen beispielsweise folgendermaßen definiert:</p><pre><code>mail.from=klarschiffhro@googlemail.com
igd_dev.mail.from=klarschiffhro@igd-r.fraunhofer.de

</code></pre><p>so wird im Normalfall als Absenderadresse die Emailadresse von Google verwendet. Ist das Profil <code>igd_dev</code> eingestellt, so wird Emailadresse von Fraunhofer verwendet.</p><p>Die folgenden Einstellungen können in der <code>settings.properties</code> vorgenommen werden:</p><h3 id="Mailversand">Mailversand</h3><table><tr><td><code>mail.server.baseurl.backend</code> und <code>mail.server.baseurl.frontend</code> </td><td>Die URLs werden bei der Erzeugung von Emails verwendet und sollten auf die entsprechenden URLs des Frontend und Backend verweisen. </td></tr><tr><td><code>mail.host</code> </td><td>SMTP-Host, der für den Versand der Emails verwendet wird </td></tr><tr><td><code>mail.smtp.starttls.enable</code> </td><td>aktiviert (<code>true</code>) oder deaktiviert (<code>false</code>) die Verschlüsselung mit dem SMTP-Host; Eine Aktivierung wird z.B. bei der Verwendung eines Google-Mail-Accounts benötigt. </td></tr><tr><td><code>mail.username</code> und <code>mail.password</code> </td><td>Benutzername und Passwort für den SMTP-Zugang, wenn dieser benötigt wird </td></tr><tr><td><code>mail.from</code> </td><td>Absenderadresse für die vom System versendeten Emails </td></tr><tr><td><code>mail.sendAllMailsTo</code> </td><td>Wenn hier eine Emailadresse angegeben wird, werden alle Emails an diese Adresse versendet. Dieses ist beispielsweise zum Test der Emailfunktionen sinnvoll. </td></tr></table><h3 id="Datenbank">Datenbank</h3><table><tr><td><code>database.host</code>, <code>database.port</code>, <code>database.schema</code>, <code>database.dbname</code>, <code>database.username</code> und <code>database.password</code> </td><td>Host, Port, Schema, Name der Datenbank, Benutzername und Password der verwendeten Datenbank für das Backend </td></tr></table><h3 id="Datenbanksynchronisation">Datenbanksynchronisation</h3><table><tr><td><code>database.initscript</code> </td><td>Hiermit wird festgelegt, ob das SQL-Script, welches für die Synchronisation der Frontend- und BackendDb auf der Basis von dbLink, ausgeführt wird. Das Script wird nur ausgeführt, wenn noch keine Tabellen in der BackendDb vorhanden sind. Die Ausführung erfolgt nach dem Erzeugen der Tabbellen in der BackendDb. Folgende Werte sind möglich: <code>disabled</code> - Script wird nicht ausgeführt, <code>warn</code> - Script wird ausgeführt und es gibt im Log eine Fehlermeldung bei einem Fehler, <code>error</code> - Script wird ausgeführt und der Start des Backend wird im Fehlerfall abgebrochen </td></tr><tr><td><code>dbsync.programdir</code> </td><td>gibt das Verzeichnis an, wo das Programm zum Synchronisieren der Frontend- und BackendDb auf der Basis von <a href="http://de.talend.com/products-data-integration/talend-open-studio.php">Talend Open Studio</a> liegt. </td></tr></table><h3 id="AutomatischJobs">Automatisch Jobs</h3><table><tr><td><code>job.monthsToArchivVorgaenge</code> </td><td>Alter abgeschlossener vorgägnge in Monaten, bis diese automatisch archiviert werden. </td></tr><tr><td><code>job.hoursToRemoveUnbestaetigtVorgang</code> </td><td>Alter von unbestätigten Vorgängen in Stunden, bis diese automatisch gelöscht werden. </td></tr><tr><td><code>job.hoursToRemoveUnbestaetigtUnterstuetzer</code> </td><td>Alter von unbestätigten Unterstutzungen in Stunden, bis diese automatisch gelöscht werden. </td></tr><tr><td><code>job.hoursToRemoveUnbestaetigtMissbrauchsmeldung</code> </td><td>Alter von unbestätigten Missbrauchsmeldungen in Stunden, bis diese automatisch gelöscht werden. </td></tr></table><h3 id="Geo">Geo</h3><table><tr><td><code>geo.map.projection</code> </td><td>verwendete Projektion im System </td></tr></table><h3 id="KartendarstellungmitOpenLayers">Kartendarstellung mit OpenLayers</h3><table><tr><td><code>geo.map.tms.server</code> </td><td>TMS für die Darstellung der Karten im Backend </td></tr><tr><td><code>geo.map.tms.server.layers</code> </td><td>Layer des TMS, die bei der Kartendarstellung verwendet werden sollen. Format: <code lang="LayerNameInDerAnzeige1">:[LayernameBeimTms1],[LayerNameInDerAnzeige2]:[LayernameBeimTms2],...</code> </td></tr><tr><td><code>geo.map.maxExtent</code> </td><td>Begrenzen der Daten der Karte </td></tr><tr><td><code>geo.map.restrictedExtent</code> </td><td>maximal anzuzeigende Größe der Karte </td></tr><tr><td><code>geo.map.resolutions</code> </td><td>Zoomstufen </td></tr><tr><td><code>geo.map.ovi.margin</code> </td><td>Darzustellender Umkreis bei der Anzeige eines Ortes </td></tr></table><h3 id="DarstellungeinesVorgangsbzw.desOrtesineinemexternenSystem">Darstellung eines Vorgangs bzw. des Ortes in einem externen System</h3><table><tr><td><code>geo.map.extern.projection</code> </td><td>Projektion im externen System (<code>geo.map.extern.url</code>) </td></tr><tr><td><code>geo.map.extern.url</code> </td><td>URL zur Darstellung eines Vorganges in einem externen System (es können die Variablen <code>%x%</code>, <code>%y%</code> und <code>%id%</code> verwendet werden) </td></tr><tr><td><code>geo.map.extern.extern.url</code> </td><td>URL zur Darstellung eines Vorgangs in einem Externen System, was von jedem Nutze im Internet aufgerufen werden kann (es können die Variablen <code>%x%</code>, <code>%y%</code> und <code>%id%</code> verwendet werden) </td></tr></table><h3 id="AnbindungdesWFSfrdenZustndigkeitsfinder">Anbindung des WFS für den Zuständigkeitsfinder</h3><table><tr><td><code>geo.wfs.url</code> </td><td>URL zum Aufruf der Capabilities des WFS </td></tr><tr><td><code>geo.wfs.wfs.exception.handling</code> </td><td>ExceptionHandling beim Initalisieren des WFS (<code>warn</code> - Fehlermeldungen werden in das Log geschrieben, <code>error</code> - der Start der Webanwendung wird bei einem Fehler abgebrochen) </td></tr><tr><td><code>geo.wfs.ovi.buffer</code> </td><td>Umkreis in Mettern, der bei der Berechnung der Features für den Zuständigkeitfinder berücksichtigt werden soll </td></tr></table><h3 id="Proxy">Proxy</h3><table><tr><td><code>proxy.host</code> und <code>proxy.port</code> </td><td>Proxyeinstellungen, die der Server zur Kommunikation mit dem Internet benötigt. Dieses wird z.B. für die Kommunikation mit WFS </td></tr></table><h3 id="LDAP">LDAP</h3><p>Es kann ein LDAP-Sever verwendet werden oder auf der Basis einer LDIF-Datei lokal ein LDAP mitgestartet werden, der dann verwendet wird. Hierzu ist jeweils der eine Parameter <code>ldap.server.ldif</code> oder <code>ldap.server.url</code> zu setzen und der andere frei zu lassen.</p><table><tr><td><code>ldap.server.ldif</code> </td><td>Wenn der Wert gesetzt ist, wird ein lokaler LDAP gestartet und die Daten aus der hier angegebenen LDIF-Datei verwendet. </td></tr><tr><td><code>ldap.server.url</code> </td><td>URL eines LDAP-Servers. </td></tr><tr><td><code>ldap.root</code> </td><td>Rootpfad für die Anfragen an den LDAP </td></tr><tr><td><code>ldap.managerDn</code> und <code>ldap.managerPassword</code> </td><td>zugangsdaten für den LDAP-Server </td></tr><tr><td><code>ldap.userSearchBase</code> </td><td>Pfad in dem nach Benutzern gesucht werden soll </td></tr><tr><td><code>ldap.userObjectClass</code> </td><td>Objektklasse für Benutzer </td></tr><tr><td><code>ldap.userSearchFilter</code> </td><td>Filter zum suchen von Benutzern </td></tr><tr><td><code>ldap.groupSearchBase</code> </td><td>Pfad in dem nach Gruppen gesucht werden soll </td></tr><tr><td><code>ldap.groupObjectClass</code> </td><td>Objektklasse für Gruppen </td></tr><tr><td><code>ldap.groupRoleAttribute</code> </td><td>Attribut in dem bei den Gruppen die Rolle <em>intern</em> oder <em>extern</em> gesetzt ist</td></tr><tr><td><code>ldap.groupSearchFilter</code> </td><td>Filter in denen bei den Gruppen nach Benutzern gesucht wird </td></tr><tr><td><code>ldap.groupObjectId</code> </td><td>Attribut mit der ID für die Gruppe </td></tr><tr><td><code>ldap.userAttributesMapping</code> </td><td>Mapping für das Auslesender Daten eines Benutzers beim LDAP. Format: <code lang="AttributNameAnwendung1">=[AttributNameLdap1],[AttributNameAnwendung2]=[AttributNameLdap2],...</code> </td></tr><tr><td><code>ldap.roleAttributesMapping</code> </td><td>Mapping für das Auslesender Daten einer Gruppe beim LDAP. Format: <code lang="AttributNameAnwendung1">=[AttributNameLdap1],[AttributNameAnwendung2]=[AttributNameLdap2],...</code> </td></tr></table><p>die folgenden abbildungen stellen zur nähren Erläuterung dar, wie Benutzer und Gruppen im LDAP abzubilden sind und wie die Einstellungen in der <code>settings.properties</code> hierzu in Beziehung stehen.</p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="imga_ldapBenutzer.jpg"/></p><p class="imgtext"><em>Abbildung:</em> Abbildung von Benutzern im LDAP</p><p>Benutzer benötigen eine <code>uid</code> und ein <code>userPassword</code>, welche für das Login verwendet werden. Der Name (<code>cn</code>) und die Mailadresse (<code>mail</code>) werden im Backend für die Anzeige von Verlaufsdaten und für den Mailversand verwendet.   </p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="imga_ldapGruppen.jpg"/></p><p class="imgtext"><em>Abbildung:</em> Abbildung von Gruppen im LDAP</p><p>Bei den Gruppen wird zwischen <code>intern</code>, <code>extern</code>, <code>dispatcher</code> und <code>admin</code> unterschieden. Die Gruppen <code>dispatcher</code> und <code>admin</code> existieren im LDAP nur jeweils einmal. die Gruppen für <code>intern</code> und <code>extern</code> existieren i.d.R. mehrfach. Die Namen der Gruppen (<code>cn</code>) und die Beschreibung (<code>ou</code>) werden bei der Anzeige der Zuständigkeit bzw. beim Delegieren verwendet. </p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="imga_ldapBenutzerGruppen.jpg"/></p><p class="imgtext"><em>Abbildung:</em> Beziehungen zwischen Benutzern und Gruppen im LDAP</p><p>Die Verknüpfung der Gruppen mit Benutzern erfolgt über das Attribut <code>member</code> bei der Gruppe. Einer Gruppe können dabei mehrere Benutzer zugeordnet sein, als auch ein Benutzer kann mehreren Gruppen angehören.</p><h3 id="Loginseite">Loginseite</h3><table><tr><td><code>show.logins</code> </td><td>Aktiviert (<code>true</code>) oder deaktiviert (<code>false</code>) eine anzeige von statischen Logindaten unter dem Login </td></tr></table><h3 id="AnzahlUntersttzerbeiIdeen">Anzahl Unterstützer bei Ideen</h3><table><tr><td><code>vorgang.idee.unterstuetzer</code> </td><td>Anzhal der Unterstützungen, die ien Idee benötigt, damit sie in der einfachen Suche angezeigt wird </td></tr></table><h3 id="Fehlermeldungen">Fehlermeldungen</h3><table><tr><td><code>show.fehler.details</code> </td><td>Aktiviert (<code>true</code>) oder deaktiviert (<code>false</code>) die ausführliche Fehleranzeige in der Webanwendung </td></tr><tr><td><code>bug.tracking.url</code> </td><td>URL auf ein Bugtracking-System, die bei einem Fehler angezeigt wird </td></tr></table><h3 id="Version">Version</h3><table><tr><td><code>version</code> </td><td>Bezeichnung der Version, die im Footer angezeigt werden soll </td></tr></table><h2 id="WebanwendungineinemClusterlaufenlassen">Webanwendung in einem Cluster laufen lassen</h2><p>Das Backend von Klarschiff ist für den Lauf in einem Cluster vorbereit. Hierzu wurden die folgenden Vorbereitungen getroffen:</p><ul><li>Die Sessionattribute implementieren das Interface <code>java.io.Serializable</code> damit die Sessions zwischen den einzelnen Clients im Cluster synchronisiert werden können.</li><li>Die Hintergrundjobs werden mit Hilfe der DB synchronisiert, damit beispielsweise Mails nicht mehrfach versendet werden.</li><li>In der <code>web.xml</code> ist der Tag <code>&lt;distributable/&gt;</code> aktiviert.</li></ul><p>Damit das Backend in einem Cluster laufen kann, müssen die folgenden Schritte vorgenommen werden:</p><ul><li>Laufen auf einem Rechner mehrere Clients so sind beim tomcat entsprechend die Ports anzupassen, damit es nicht zu Konflikten kommt.</li><li>In der <code>server.xml</code> des einzelnen Tomcat muss eine ID für den Client (<code>jvmRoute="worker1"</code>) vergeben werden und der Lauf in einem Cluster muss aktiviert werden (<code>&lt;Cluster .../&gt;</code>).</li></ul><pre><code>	&lt;Engine defaultHost="localhost" name="Catalina" jvmRoute="worker1"&gt;
		&lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/&gt;
	...
	&lt;/Engine&gt;
</code></pre><p></p><ul><li>Ein Loadbalancer für die Verteilung der Anfragen auf die einzelnen Clients muss eingerichtet werden. Hierzu kann beispielsweise ein Apache verwendet werden.</li></ul><p>Nähere Information zum einrichten eines Tomcat in einem Cluster ist beispielsweise unter <a href="http://www.easywayserver.com/implementation-tomcat-clustering.htm">http://www.easywayserver.com/implementation-tomcat-clustering.htm</a> zu finden.</p></body></html>